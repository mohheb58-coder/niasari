function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("sheet1");
    
    if (!sheet) {
      return buildJsonpResponse({ status: "error", message: "Sheet not found" }, e.parameter);
    }
    
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues();
    
    const headers = data.length > 0 ? data[0] : [];
    const rows = data.slice(1).map(r => {
      const obj = {};
      headers.forEach((h, i) => obj[h] = r[i] !== undefined ? r[i] : '');
      return obj;
    });

    // دریافت پارامترها
    let params = e.parameter || {};
    
    // اگر POST بود
    if (e.postData) {
      try {
        const content = e.postData.contents;
        if (content) {
          params = JSON.parse(content);
        }
      } catch (ex) {
        Logger.log('Parse error: ' + ex);
      }
    }

    const action = params.action;
    const callback = params.callback;

    // getAll
    if (action === "getAll") {
      return buildJsonpResponse(rows, params);
    } 
    
    // getByLastName
    if (action === "getByLastName") {
      const lastName = (params.lastName || "").trim().toLowerCase();
      const filtered = rows.filter(r => 
        String(r.lastName || '').trim().toLowerCase() === lastName
      );
      return buildJsonpResponse(filtered, params);
    } 
    
    // create
    if (action === "create") {
      const newRow = headers.map(h => params[h] !== undefined ? params[h] : "");
      sheet.appendRow(newRow);
      return buildJsonpResponse({ status: "success", message: "Record created successfully" }, params);
    } 
    
    // update
    if (action === "update") {
      const key = params.key;
      const keyColIndex = findKeyColumn(headers);
      
      if (keyColIndex < 0) {
        return buildJsonpResponse({ status: "error", message: "No key column found" }, params);
      }

      let found = false;
      for (let i = 1; i < data.length; i++) {
        if (String(data[i][keyColIndex] || '').trim() === String(key).trim()) {
          headers.forEach((h, j) => {
            sheet.getRange(i + 1, j + 1).setValue(params[h] !== undefined ? params[h] : "");
          });
          found = true;
          break;
        }
      }
      
      if (!found) {
        return buildJsonpResponse({ status: "error", message: "Record not found" }, params);
      }
      
      return buildJsonpResponse({ status: "success", message: "Record updated successfully" }, params);
    } 
    
    // delete
    if (action === "delete") {
      const key = params.key;
      const keyColIndex = findKeyColumn(headers);
      
      if (keyColIndex < 0) {
        return buildJsonpResponse({ status: "error", message: "No key column found" }, params);
      }

      let found = false;
      for (let i = data.length - 1; i >= 1; i--) {
        if (String(data[i][keyColIndex] || '').trim() === String(key).trim()) {
          sheet.deleteRow(i + 1);
          found = true;
          break;
        }
      }
      
      if (!found) {
        return buildJsonpResponse({ status: "error", message: "Record not found" }, params);
      }
      
      return buildJsonpResponse({ status: "success", message: "Record deleted successfully" }, params);
    }

    return buildJsonpResponse(rows, params);
    
  } catch (error) {
    Logger.log('Error: ' + error.toString());
    return buildJsonpResponse({ 
      status: "error", 
      message: "Server error: " + error.toString() 
    }, e.parameter);
  }
}

function findKeyColumn(headers) {
  const idxPersonnel = headers.indexOf("personnelCode");
  const idxNational = headers.indexOf("nationalId");
  if (idxPersonnel >= 0) return idxPersonnel;
  if (idxNational >= 0) return idxNational;
  return -1;
}

function buildJsonpResponse(data, params) {
  const callback = params.callback || 'callback';
  const output = ContentService
    .createTextOutput(callback + '(' + JSON.stringify(data) + ')')
    .setMimeType(ContentService.MimeType.JAVASCRIPT);
  
  // اضافه کردن CORS headers
  output.append(''); // Dummy append برای CORS
  return output;
}
